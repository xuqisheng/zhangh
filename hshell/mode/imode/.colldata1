#!/bin/bash 
# ---------------------------------------------------------------------------------------------------------------------------------------------------------------
# function:
# ----------------------------------------------------------------------------------------------------------------------------------------------------------------


Hsid=`/root/mode/.modesid`
Hsapache=
/root/mode/seetom | 
while read -r Hc1 Hc2 Hcother;do
   #
   if echo $Hc1 | grep -E "^[sS]ingle$" >/dev/null; then
      Hsapache=
      Hat=$Hc2
   else
      if [ "$Hsapache" = "$Hc1" ]; then
          continue
      fi
      Hsapache=$Hc1
      Hat=$Hc1
   fi
   #
   if echo "$Hat" | grep -E "^apache" >/dev/null; then
      Hat1=`echo $Hat | sed -re "s/^apache(.*)/build\1.properties/"`
   else
      Hat1="$Hat.properties"
   fi
   #
   Happs=`echo "$Hcother" | sed -re "s/\(([^\)]*)\).*/\1/"`
   # try to get version
   if echo "$Hat" | grep -E "^apache" >/dev/null; then
      Hverpos=htdocs
   else
      Hverpos=webapps
   fi
   if echo "$Happs" | grep -E "ipms" >/dev/null; then
      if echo "$Happs" | grep -E "ipmsthe" >/dev/null; then
         Hverfile="/usr/local/$Hat/$Hverpos/thef/update.xml"
         Hvmark=versionNumber
      else
         Hverfile="/usr/local/$Hat/$Hverpos/update/update.xml"
         Hvmark=mainVersion
      fi
   elif echo "$Happs" | grep -E "PosClient" >/dev/null; then
      Hverfile="/usr/local/$Hat/$Hverpos/PosClient/versionupdate.xml"
      Hvmark=versionNumber
   elif echo "$Happs" | grep -E "mobilepms" >/dev/null; then
      Hverfile="/usr/local/$Hat/$Hverpos/mobilepms/version.xml"
      Hvmark=serverVersion
   else 
      Hverfile=
      Hvmark=versionNumber
   fi
   if [ -f "$Hverfile" ]; then
      Happver=`cat "$Hverfile" 2>/dev/null | grep -E "$Hvmark" | sed -re "s/.*<$Hvmark>(.*)<\/$Hvmark>.*/\1/"`
      Hdedate=`ls -l --full-time $Hverfile | awk '{print $6}'`
   else
      Happver=NULL
      Hdedate=NULL
   fi

   #
   Hdbip=`/root/mode/mod_config /root/antDep/$Hat1 'db.root' '#Get#' 2>/dev/null`
   Hdbname=`/root/mode/mod_config /root/antDep/$Hat1 'db.name' '#Get#' 2>/dev/null`
   #
   if [ -z "$Hdbip" ]; then
      :
   elif echo "$Happs" | grep -E '(sync|mobilepms)' >/dev/null; then
      Hdbip=
      Hdbname=
   elif echo "$Happs" | grep -E '^$' >/dev/null; then
      Hdbip=
      Hdbname=
   fi
   Hnow=`date '+%Y-%m-%d %H:%M:%S'`
   echo -e "`uuidgen | sed -re 's/-//g'`\t$Hsid\t$Hat\t$Happs\t$Happver\t$Hdedate\t$Hdbip\t$Hdbname\t何仁尧\thry\t$Hnow"
done


