#!/bin/bash 

#

/root/mode/withyou $$ gc_doslowtop 1 && exit

#

if [ -n "$2" ]; then
   # mail to gl,gds,dgp
   cat /topslowone.list | tr -d '\r' | mail -s "Top one slow sql list of importent servers `LANG=en_US;date`" zhanghui@ipms.cn gaoliang@ipms.cn gds@ipms.cn 12984505@qq.com yangchao@ipms.cn cys@ipms.cn 625835738@qq.com
   exit
fi

#

. /root/imode/cfg/.imode_aliases

#

{
echo 
echo "##################################################################################################"
echo "# query_time top one list of importent servers                                                   #"
echo "#        ------ extracted on `date +%Y-%m-%d` using data generated by badsql_query_time mode utilities #" 
echo "##################################################################################################"
echo
} >/root/mode/tmp/htopfile$$.tmp
>/root/mode/tmp/htopfile$$.tmp1

for i in `cat /root/topsshc.txt | grep -v "^#" | grep -E "^${1:-.*}$"`; do
   
   #

   Htopquery_time=`/root/imode/gc_sshc_topquery_time "$i"`
   if [ -z "$Htopquery_time" ]; then
      continue
   fi

   #
   

   Htop1from=$[`echo "$Htopquery_time" | sed -n '/# Ranked 1 / ='`-1]
   Htop2from=$[`echo "$Htopquery_time" | sed -n '/# Ranked 2 / ='`-1]
   if [ "$Htop1from" = "-1" ]; then 
      Htop1from='1'
   fi
   if [ "$Htop2from" = "-1" ]; then 
      Htop2from='$'
   fi
   
   #

   Hsc=`/root/imode/gc_sshc_sc "$i"`
   Hssh_des=`/root/mode/seecfg -s "select descript from gc_sshto_servers where code='$i'" gc_admin`
   Hssh_ip0=`/root/mode/seecfg -s "select ip0      from gc_sshto_servers where code='$i'" gc_admin`
   Hssh_ip2=`/root/mode/seecfg -s "select ip2      from gc_sshto_servers where code='$i'" gc_admin`
   if [ -z "$Hssh_ip2" ]; then
      Hssh_ip=$Hssh_ip0
   else
      Hssh_ip="$Hssh_ip2 -> $Hssh_ip0"
   fi

   {
   echo "## server code : $Hsc"
   echo "## ssh code    : $i"
   echo "## descript    : $Hssh_des"
   echo "## connect ip  : $Hssh_ip"
   echo
   echo "$Htopquery_time" | sed -n "$Htop1from,$Htop2from p" 
   } >> /root/mode/tmp/htopfile$$.tmp1
   
done

#

cat /root/mode/tmp/htopfile$$.tmp1 | sed -re "s/$/HrYhBy/" | tr -d "\n" | sed -re  "s/(HrYhBy#+ server code :)/\n\1/g"  |
sed -re "s/(.*Query_time: ([^ ]+).*)/\2 \1/" | sort -gr | 
sed -re "s/^[^ ]+ (.*)/\1/" |
sed -re "s/HrYhBy/\n/g" >> /root/mode/tmp/htopfile$$.tmp

#

rm -f /root/mode/tmp/htopfile$$.tmp1

# 

if [ `/root/mode/traceps "crond"` = 'suc' -o -n "$2" ]; then
   # mail to gl,gds,dgp
   cat /root/mode/tmp/htopfile$$.tmp | tr -d '\r' | 
   mail -s "Top one slow sql list of importent servers `LANG=en_US;date`" zhanghui@ipms.cn gaoliang@ipms.cn gds@ipms.cn 12984505@qq.com yangchao@ipms.cn cys@ipms.cn 625835738@qq.com
   mv -f /root/mode/tmp/htopfile$$.tmp /.topslowone.list
   cp -f /.topslowone.list /topslowone.list
else
   mv -f /root/mode/tmp/htopfile$$.tmp /topslowone.list
   echo
   echo "Please view /topslowone.list"
   echo
fi

#


