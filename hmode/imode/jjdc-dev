#
. /root/imode/cfg/.imode_aliases
#
# -----------------------------------------------------------------------------
# function:
#           execute sql files in directory $1 at remote servers 
# usage   :
#           ./iseecfg <filex.sql> [<remote-server> [<database>]]
#           ./iseecfg <local-dir> [<remote-server> [<database>]]
# -----------------------------------------------------------------------------
# remarks :
#           servername may be 'allservers'
#           database name may be empty.In such case it defaults to portal
# -----------------------------------------------------------------------------
# e.g.    :
#           ./iseecfg /1.sql anyinew 
#           ./iseecfg /root/antDep/database anyinew     portal
#           ./iseecfg /root/antDep/database allservers  portal
#           ./iseecfg /root/antDep/database anyinew     portal_tr
#           ./iseecfg /root/antDep/database allservers  portal_tr
# -----------------------------------------------------------------------------

# 

if [ -z "$1" ]; then
   /root/mode/modemsg iseecfg "Please provide sql file or directory!"
   exit
elif [ -d "$1" ]; then
   # directory check
   if [ "$1" = "/" ]; then
      /root/mode/modemsg iseecfg "Directory \"/\" is not allowed!"
      exit
   elif [ `du -s -m "$1" | sed -re "s/^([0-9]*).*/\1/"` -gt 20 ]; then
      /root/mode/modemsg iseecfg "Too big a directory!"
      exit
   else 
      find "$1" -name "*.sql" | 
      while read -r i;do
         if head -n 20 "$i" | grep "mode generated header" >/dev/null; then
            /root/mode/modemsg iseecfg "There exists a mode generated dump.Dump is forbidden to load remotely!"
            exit
         elif head -n 20 "$i" | grep "MySQL dump.*Distrib" >/dev/null; then
            /root/mode/modemsg iseecfg "There exists a sql dump.Dump is forbidden to load remotely!"
            exit
         fi
      done
   fi
elif [ ! -f "$1" ]; then
   /root/mode/modemsg iseecfg "File $1 doesn't exist!"
   exit
elif echo "$1" | grep -E "\.sql$" >/dev/null; then
   # sql file check
   if head -n 20 "$1" | grep "mode generated header" >/dev/null; then
      /root/mode/modemsg iseecfg "Mode generated sql dump.Dump is forbidden to load remotely!"
      exit
   elif head -n 20 "$1" | grep "MySQL dump.*Distrib" >/dev/null; then
      /root/mode/modemsg iseecfg "Sql dump not generated by mode.Dump is forbidden to load remotely!"
      exit
   elif [ `du -s -m "$1" | sed -re "s/^([0-9]*).*/\1/"` -gt 50 ]; then
      /root/mode/modemsg iseecfg "Too big sql file!"
      exit
   fi
else
   /root/mode/modemsg iseecfg "Parameter 1 must be directory name or sql file name!"
   exit
fi

Hserver="$2"
if [ "$Hserver" = "allservers" ]; then
   /root/mode/confirm "Sql file(s) will be executed on all registered servers.Continue" hello || exit 
   Hserver=".*"
   Hserverdes="all servers"
elif [ -z "$Hserver" ]; then
   /root/mode/modemsg iseecfg "Please provide server parameters!"
   exit
else
   Hserverdes="server $2"
fi

Hdatabase=${3:-portal}

#

Htar=/root/mode/tmp/iseecfg`/root/mode/getips | sed -n "1 p"`$$.tar.gz
Hdir=/root/mode/tmp/iseecfg`/root/mode/getips | sed -n "1 p"`$$
tar czvf $Htar "$1" >/dev/null 2>&1

if /root/mode/confirm "SQL(s) will be executed in database $Hdatabase at $Hserverdes right away.Continue" hello; then  
   for i in `cat /root/servers.txt | grep -v "^#" | grep -E "^$Hserver$"`; do
      echo " ============================ $i ============================"
      echo
      scp $Htar $i:/root/mode/tmp
      ssh $i "mkdir -p $Hdir;tar xzvf $Htar -C $Hdir >/dev/null 2>&1;/root/mode/updatedb.sh $Hdir $Hdatabase"
      ssh $i "rm -fR $Htar $Hdir"
   done
fi
rm -fR $Htar

#

